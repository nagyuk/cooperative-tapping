# 協調タッピング課題 実験システム要件定義書

## 1. プロジェクト概要

### 1.1 研究背景

人間は柔らかく不安定な構造を基盤としているのに対して、機械は固く安定な構造を基盤としているため、両者の調和には課題があります。例えば、幼い子供でも誰かと合わせて音楽を演奏することは可能ですが、メトロノームと同調してリズムを刻むことは難しいという現象が見られます。現在のリアルタイム演奏システムでは、機械学習による予測と意図的なノイズ付加によって近似的に柔らかさを実現していますが、より本質的なアプローチが求められています。

### 1.2 研究目的

本研究では、ベイズ推論と逆ベイズ（BIB）推論を組み合わせた「やわらかい予期」モデルを開発し、協調タッピング課題における人間と機械の同調関係の改善を目指します。このモデルは単なる近似ではなく、人間の持つ不安定性を正面から表現するモデルとして設計されます。これにより、人間と機械の調和的関係を構築する際のギャップを軽減することが期待されます。

### 1.3 システムの目的

協調タッピング課題を通じて、人間のタイミング制御機構に関する理解を深め、特に双方向の協調作業におけるタイミング共有のメカニズムを解明するための実験システムを開発します。このシステムは、ミリ秒単位の正確な時間測定が求められるため、高精度なタイミング制御と計測機能を備える必要があります。

## 2. 実験要件

### 2.1 実験の種類

本システムでは交互タッピング課題をサポートします。交互タッピング課題では、人間とシステムが交互にタップを行い、連続する刺激音のちょうど中間の時刻に合わせてタップするよう試みます。

### 2.2 実験パラメータ

実験の基本パラメータは以下の通りです：

- **基準間隔（SPAN）**: 2.0秒（デフォルト、設定可能）
- **Stage1（メトロノーム段階）のタップ回数**: 10回（デフォルト、設定可能）
- **Stage2（相互作用段階）のタップ回数**: 100回（デフォルト、設定可能）
- **データ除外バッファ**: 10タップ（前後から除外するタップ数、設定可能）
- **分散スケール**: 0.1（ランダム性の度合い、設定可能）

### 2.3 測定データ

以下のデータを記録し分析する必要があります：

- **刺激音タップ時刻（Stim_tap）**: システムが音を鳴らした時刻
- **被験者タップ時刻（Player_tap）**: 被験者がタップした時刻
- **同期誤差（SE: Synchronization Error）**: タップと理想的なタイミングとの差
- **タップ間隔（ITI: Inter Tap-onset Interval）**: 連続するタップの間隔
- **同期誤差の変化（SEv）**: 連続する同期誤差の差分
- **タップ間隔の変化（ITIv）**: 連続するタップ間隔の差分

これらのデータは実験中リアルタイムに記録され、後の分析のために保存する必要があります。

### 2.4 アルゴリズムモデル

本システムでは以下の3種類のアルゴリズムモデルをサポートします：

1. **SE平均モデル（SEA）**: 過去の同期誤差の平均に基づいてタイミングを調整するシンプルなモデル
2. **ベイズモデル（Bayes）**: ベイズ推論を用いて同期誤差を予測し、タイミングを調整するモデル
3. **ベイズ−逆ベイズモデル（BIB）**: ベイズ推論に逆ベイズ推論を組み合わせ、仮説自体も更新するモデル

各モデルは独立して実装され、実験時に選択できるようにします。

## 3. システム要件

### 3.1 技術要件

- **プログラミング言語**: Python 3.9以上
- **必須ライブラリ**:
  - PsychoPy (バージョン2023.1.0以上): 刺激提示と反応計測用
  - NumPy (バージョン1.20.0以上): 数値計算用
  - SciPy (バージョン1.7.0以上): 統計処理用
  - Matplotlib (バージョン3.4.0以上): データ可視化用
  - Pandas (バージョン1.3.0以上): データ処理用
- **オペレーティングシステム**: Windows および macOS で動作すること
- **バージョン管理**: GitHub でソースコードを管理

### 3.2 ハードウェア要件

- **処理速度**: 高速なCPU（ワークステーション推奨）
- **モニター**: リフレッシュレート60Hz以上、解像度1920x1080以上
- **入力デバイス**: 低遅延のキーボード（Realforce R3S推奨）
- **音声出力**: 低遅延のオーディオシステム

### 3.3 精度要件

- **時間計測精度**: 1ms以下
- **タイミング精度**: 10ms以下のシステム応答時間
- **サンプリングレート**: 1000Hz以上（1ms解像度）

### 3.4 ユーザーインターフェース要件

- **フィードバック**: 音声によるタップのフィードバック
- **キー操作**: スペースキーによるタップ入力、ESCキーによる実験中断
- **注意事項**: 被験者は実験中に瞑目（目を閉じた状態）で行うため、視覚的フィードバックは不要

### 3.5 データ保存要件

- **ファイル形式**: CSV形式で各種データを保存
- **保存内容**:
  - タップ時刻データ（Stim_tap, Player_tap）
  - 同期誤差データ（Stim_SE, Player_SE）
  - タップ間隔データ（Stim_ITI, Player_ITI）
  - 変化量データ（ITIv, SEv）
  - モデル状態データ（ベイズモデルおよびBIBモデルの仮説情報）
- **ファイル命名規則**: `{モデル名}_{実験ID}_{データ種類}.csv`
- **実験ID生成**: YYYYMMDDHHMMフォーマットのタイムスタンプ

## 4. 機能要件

### 4.1 実験制御機能

- **Stage1（メトロノーム段階）**: 一定間隔でシステムが音を鳴らし、被験者はそのリズムに合わせてボタンを押す。この段階では刺激音はインタラクションで変動せず、一定のタイミングで出力される。
- **Stage2（相互作用段階）**: システムと被験者が交互にタップし、タイミングを調整する。Stage1がないと互いのタップが加速し実験が成立しなくなる「負の非同期」現象が生じる可能性がある。
- **実験開始/終了処理**: 実験の開始と終了を管理
- **エラー処理**: 実験中のエラーを検出し、適切に対処

### 4.2 モデル実装要件

#### 4.2.1 基底モデル

すべてのモデルは共通インターフェースを実装し、以下のメソッドを提供する必要があります：

- `inference(se)`: 同期誤差から次のタップタイミングを予測
- `reset()`: モデル状態を初期化
- `get_state()`: 現在のモデル状態を取得（ログ/分析用）

#### 4.2.2 SE平均モデル

- 過去の同期誤差（SE）の平均を計算
- 計算式: ITI(n) = ITI0 + h・Σ(SE(j)) （j=1からnまで）
- 平均誤差に基づいてタップタイミングを調整

#### 4.2.3 ベイズモデル

- 同期誤差（SE）に基づくベイズ推論を実装
- 仮説空間: x_min=-3からx_max=3
- 仮説数: n_hypothesis=20（デフォルト、設定可能）
- 尤度関数: 正規分布N(likelihood[i], 0.3)
- 事後確率に基づくサンプリングによるタイミング予測

#### 4.2.4 BIBモデル

- ベイズモデルの機能を拡張
- メモリ長パラメータ（l_memory）: 
  - l_memory=0の場合、通常のベイズ推論のみを行う
  - l_memory≥1の場合、逆ベイズ推論も行う
  - メモリ長は観測データの記憶バッファサイズを指定し、これに基づいて仮説の更新を行う
- 逆ベイズ操作: 最も確率の低い仮説を過去のデータ分布の平均で置換
- より柔軟な仮説更新メカニズム

### 4.3 データ分析機能

基本的なデータ保存機能を優先し、詳細な分析機能は後続フェーズで実装します。

## 5. 制約条件

### 5.1 実験の制約

- **実験時間**: 1回の実験は5分以内
- **被験者の姿勢**: 座位、右手人差し指でスペースキーを押下
- **指示**: 右手人差し指以外の体の部位を使ってリズムを取ることを禁止
- **環境**: 静かな環境で実施
- **実験条件**: 被験者は瞑目（目を閉じた状態）で実験を行う

### 5.2 システムの制約

- **処理遅延**: 音の出力とキー入力の遅延は10ms以下
- **システム負荷**: CPU使用率が80%を超えないこと
- **メモリ使用**: 使用可能なメモリの50%以下
- **クロスプラットフォーム**: Windows および macOS で同等の性能を発揮すること

## 6. 検証方法

### 6.1 システム検証

- **時間精度検証**: 時間計測の精度をハードウェアタイマーと比較
- **遅延測定**: 入力から処理、出力までの遅延を測定
- **安定性テスト**: 長時間実行時の安定性を確認
- **クロスプラットフォームテスト**: Windows と macOS での動作確認

### 6.2 実験結果検証

- **データ一貫性**: 記録されたデータの一貫性を確認
- **パラメータ感度**: パラメータ変更時の結果変化を確認
- **モデル比較**: 各モデルの性能を比較分析

## 7. 用語集

- **SE (Synchronization Error)**: タップと理想的なタイミングとの差
- **ITI (Inter Tap-onset Interval)**: 連続するタップ間の時間間隔
- **SEv**: 連続する同期誤差の変化量
- **ITIv**: 連続するタップ間隔の変化量
- **Stage1**: メトロノームが一定間隔で鳴り、被験者がボタンを押す初期段階
- **Stage2**: 人間とシステムが相互に影響する段階
- **ベイズ推論**: 観測データに基づいて確率的に推論を行う手法
- **逆ベイズ推論**: 仮説モデル自体を更新する手法
- **負の非同期**: タップが加速していく現象、Stage1がないと実験が成立しなくなる原因
- **瞑目**: 目を閉じた状態