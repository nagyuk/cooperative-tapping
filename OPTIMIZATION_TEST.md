# ステージ移行最適化テストガイド

## 最適化内容
この最適化により、ステージ1と2間のラグが大幅に削減されました。

### 実装された最適化
1. **PTB音声システム最高精度設定**
   - audioBufferSize: 128 → 64 (最小化)
   - audioLatencyMode: 4 (最高精度)
   - システム環境変数設定

2. **音声再生の即座実行**
   - 全音声再生にwhen=0パラメータ追加
   - 音声オブジェクト最適化設定

3. **時間計算簡素化**
   - 複雑な計算を単純なmodulo演算に変更
   - 最小待機時間: 0.3秒 → 0.05秒

## テスト手順

### 1. 基本動作確認
```bash
cd /Users/sasailab/cooperative-tapping
source venv_py39/bin/activate
python scripts/run_experiment.py --model sea --stage1 5 --stage2 10
```

### 2. 音声遅延測定
実験開始時に以下の情報を確認：
- "PTB最適化設定による音声オブジェクト作成に成功しました"
- プロセス優先度設定の成功メッセージ

### 3. ステージ移行の確認
Stage1完了時から最初のStage2刺激音までの時間を体感で確認：
- **最適化前**: 1秒以上のラグ
- **最適化後**: ほぼシームレス（50ms以下）

### 4. データ整合性確認
実験終了後、生成されたCSVファイルを確認：
- raw_taps.csv（Stage1+2の全データ）
- processed_taps.csv（バッファ除去後）

## トラブルシューティング

### 音声作成失敗時
```
警告: PTB最適化設定での音声作成に失敗しました
```
→ 自動的にトーン音にフォールバック（問題なし）

### プロセス優先度設定失敗時
```
INFO: プロセス優先度の変更が許可されていません
```
→ 管理者権限で実行するか、そのまま継続（軽微な影響）

## 期待される改善
- **ステージ移行遅延**: 1秒以上 → 50ms以下
- **音声再生遅延**: 大幅削減
- **時間計算処理**: 2-3倍高速化

## 注意事項
- PTBがインストールされていない場合は自動フォールバック
- 実験精度は大幅に向上しているため、より正確なデータが取得可能
