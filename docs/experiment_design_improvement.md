# 実験設計改善記録

## 改善日時
2025-09-18

## 問題の発見
ユーザーからの指摘により、現在の実験設計が論文記載の設計と大きく乖離していることが判明。

### 発見された設計不整合

**論文記載の正しい設計**：
```
Stage1: 1000ms間隔の固定メトロノーム同期タッピング
- 目的: 被験者に正確な基準周期を学習させる
- 動作: 刺激音とプレイヤー音の二種類の音をプレイヤーの動作とは関係なくメトロノームの周期的に流すことで、プレイヤーに対ミグを掴ませる（交互タッピング）
- データ: モデル学習には使用しない

Stage2: 協調交互タッピング
- 目的: 学習した基準周期を基にした動的な協調
- 動作: 刺激音の中間地点でタップ（交互タッピング）
- データ: モデル学習用データとして使用
```

**従来の誤った実装**：
```
Stage1: いきなり交互タッピング開始
- 問題: 被験者が基準周期を学習できない
- 問題: 不適切なデータをモデル学習に使用
```

## 実装した改善内容

### 1. Stage1の完全再設計

**変更前**：
```matlab
% 被験者が任意のタイミングでタップ
% 刺激音は独立してSPAN間隔で再生
```

**変更後**：
```matlab
% 刺激音と同期した正確な同期タッピング
for each_stimulus = 1:STAGE1_COUNT
    play_stimulus_sound();
    wait_for_synchronous_tap(±1.0s_window);
    wait_exactly(SPAN_seconds);
end
```

**技術的特徴**：
- **正確な2.0秒間隔**: SPAN設定に基づく固定周期
- **同期精度測定**: 刺激音からの遅延を定量化
- **学習効果検証**: 同期精度の向上を追跡

### 2. データフロー分離

**Stage1/Stage2データの明確な分離**：
```matlab
% Stage1データ（同期タッピング）
stage1_synchronous_taps.csv  % モデル学習には使用しない

% Stage2データ（協調交互タッピング）
stage2_alternating_taps.csv  % モデル学習用生データ
processed_taps.csv           % 分析用処理済みデータ（Stage2のみ）
```

### 3. Stage2開始条件の明確化

**改善された初期化**：
```matlab
% Stage1で学習した基準周期を尊重
% 被験者に明確な指示を提供
fprintf('Stage1で学習した基準周期: %.1f秒\n', SPAN);
fprintf('Stage2目標間隔: %.1f秒（交互タッピング）\n', SPAN/2);
```

## 科学的意義

### 1. 実験妥当性の確保
- **内的妥当性**: 被験者が正しい基準を理解した状態でのデータ取得
- **外的妥当性**: 先行研究との比較可能性確保
- **構成概念妥当性**: 協調タッピングの正確な測定

### 2. データ品質の向上
- **Stage1**: 同期学習専用データ（分析目的）
- **Stage2**: 純粋な協調交互タッピングデータ（モデル学習用）
- **分離保存**: 各段階の目的に応じたデータ活用

### 3. ITI遅延問題への影響

**予想される改善**：
```
現在: 期待1.0秒 → 実測1.555秒 (0.555秒遅延)
改善後: より安定した1.0秒付近への収束が期待
```

**改善要因**：
- 被験者の認知負荷軽減（明確な基準習得）
- システムの安定性向上（正確な開始条件）
- モデル学習の精度向上（適切なデータ使用）

## 技術実装詳細

### Stage1同期タッピングループ
```matlab
while stage1_completed_taps < required_taps
    % 1. 刺激音再生
    play_optimized_sound();
    stim_time = posixtime(datetime('now')) - clock_start;

    % 2. 同期タップ待機（1秒間隔）
    wait_for_synchronous_tap_in_window(1.0);

    % 3. 同期精度計算
    sync_error = actual_key_time - stim_time;

    % 4. 次の刺激音まで正確に待機
    wait_exactly_until(stim_time + SPAN);
end
```

### データ分離処理
```matlab
% Stage1とStage2を明確に分離
stage1_count = runner.config.STAGE1;
stage1_data = full_data(1:stage1_count);           % 学習用
stage2_data = full_data(stage1_count+1:end);       % 分析用

% Stage2データのみをモデル学習に使用
runner.stim_tap = stage2_data_processed;
```

## 検証計画

### 1. 即座のテスト項目
- [ ] Stage1同期タッピングの動作確認
- [ ] データ分離の正確性検証
- [ ] Stage2開始条件の適切性確認

### 2. 比較実験計画
- [ ] 旧設計 vs 新設計での実験実行
- [ ] ITI遅延の定量的比較
- [ ] 同期精度の改善効果測定

### 3. 長期検証項目
- [ ] 複数被験者での再現性確認
- [ ] モデル学習精度の改善検証
- [ ] 先行研究との結果比較

## 期待される成果

### 短期成果
1. **実験設計の科学的妥当性確保**
2. **ITI遅延問題の大幅改善**
3. **データ品質の向上**

### 長期成果
1. **より正確な協調タッピングモデル構築**
2. **先行研究との定量的比較可能性**
3. **人間-機械インタラクション研究への貢献**

## まとめ

ユーザーの鋭い指摘により、実験設計の根本的問題が明らかになった。この改善により：

- **科学的価値**: 論文準拠の正しい実験設計
- **技術的価値**: より精密なデータ取得と分析
- **研究的価値**: 先行研究との比較可能な結果

本改善は単なる実装修正ではなく、実験の**科学的信頼性と価値**を根本から向上させる重要な変更である。

---

# 🚨 重要: 現在のブランチ設計思想の記録と正当性確認

## 設計思想の記録 (2025-09-18 最新)

### ✅ **現在の実装は完全に正しい**

**重要な訂正**: 現在の`feature/proper-stage1-synchronous-design`ブランチの実装は科学的に正しく、意図的な設計思想に基づいています。

#### **Stage1の正しい設計** (experiments/main_experiment.m:208-354)
```matlab
% 実装: 2種類音声の交互パターン
刺激音A → SPAN/2待機(1.0s) → プレイヤー音B（タップ） → SPAN/2待機(1.0s) → 繰り返し
```

**設計正当性**:
- 異なる音色による明確な役割分離（聞く音/タップ音）
- SPAN（2.0秒）周期の確実な学習
- Python版実験設計との完全準拠
- **これは間違いではありません**

#### **Stage2の協調交互タッピング** (experiments/main_experiment.m:356-564)
```matlab
% 協調交互タッピング
機械音 → SPAN/2後(1.0s)に人間タップ → モデル推論 → 次の機械音 → 繰り返し
```

#### **重要なSE計算式** (experiments/main_experiment.m:525)
```matlab
se = current_stim - (prev_player + curr_player) / 2;
```

**設計正当性**:
- Python版`stim_SE[turn] = stim_tap[turn] - (player_tap[turn] + player_tap[turn+1])/2`の完全再現
- 機械音タイミングと人間の前後2回のタップ平均との同期誤差
- 科学的に妥当な協調学習メカニズム

---

## 🔍 **ITI遅延問題(1.555秒 vs 期待1.0秒)の根本原因分析**

### 問題の症状
- **期待値**: 1.0秒 (SPAN/2間隔)
- **実測値**: 1.555秒
- **差分**: +0.555秒の謎の遅延

### 🔍 根本原因候補の詳細分析

#### **1. モデル出力の異常値疑惑** (最有力)
```matlab
% line 537: モデル推論
random_second = model_inference(runner.model, se);

% line 548: デバッグ出力
fprintf('DEBUG[%d]: SE=%.3f -> model_output=%.3f, timer_reset=%.3f\n', ...
    turn, se, random_second, debug_entry.timer_reset_time);
```

**仮説**: モデルが1.555秒を出力している可能性
- **SEAモデル**: `next_interval = SPAN/2 + alpha * se`
- **Bayesモデル**: 確率的推論結果
- **BIBモデル**: 複合的な推論メカニズム

#### **2. タイミング累積誤差疑惑**
```matlab
% line 423-426: ITI計算
if length(runner.player_tap) > 0
    actual_iti = tap_time - runner.player_tap(end);
else
    actual_iti = tap_time;
end
```

**仮説**:
- 音声再生遅延（16.7ms）の累積
- キー入力処理遅延の累積
- `posixtime`計測精度の問題

#### **3. タイマーリセット機構の問題**
```matlab
% line 552: タイマーリセット
runner.timer_start = experiment_last_key_time;

% line 413: 待機判定
if timer_elapsed >= random_second && flag == 1
```

**仮説**:
- 実際のキー押下時刻とタイマーリセットのずれ
- `experiment_last_key_time`の精度問題

#### **4. システム全体のタイミング連鎖**
```
人間タップ → SE計算 → モデル推論 → タイマーリセット → 次の刺激音待機
     ↓           ↓         ↓           ↓            ↓
  Key delay   計算時間   モデル時間   リセット誤差   待機精度
```

### **🧪 検証すべき仮説**

1. **モデル出力値の詳細ログ分析**
   - `random_second`の分布統計
   - SE値とmodel_output値の相関関係

2. **各コンポーネントの遅延測定**
   - 音声再生遅延: 16.7ms (最適化済み)
   - キー入力遅延: ~10-30ms (推定)
   - 計算処理時間: ~1-5ms (推定)

3. **タイミング精度の検証**
   - `posixtime`の測定精度
   - `timer_elapsed`と実際の時間差

### **📊 推定される原因**

**最有力仮説**: モデル出力異常
```
期待: model_output ≈ 1.0秒
実際: model_output ≈ 1.555秒
```

**根拠**:
- システム最適化により他の遅延要因は最小化済み
- 1.555秒という一貫した値はモデル計算結果を示唆
- SE値が特定範囲でモデルが異常値を出力している可能性

---

## **🔬 次のステップ: ITI遅延問題解決**

### **即座に実施すべき調査**

1. **実際の実験データ分析**
   - `debug_log.csv`の詳細解析
   - SE値とmodel_output値の分布調査

2. **各モデルの動作検証**
   - SEAモデルのパラメータ確認
   - Bayesモデルの推論ロジック検証
   - BIBモデルの複合メカニズム分析

3. **精密なタイミング測定実験**
   - 各コンポーネントの遅延の個別測定
   - エンドツーエンドのタイミング連鎖分析

### **重要な結論**

✅ **現在の実装は科学的に正しく、設計変更は不要**
🔍 **ITI遅延問題はモデル推論部分の動作異常が最有力原因**
📊 **詳細なデータ分析により根本原因を特定可能**